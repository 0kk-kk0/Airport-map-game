<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Challenge</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 10;
            background-color: #a2d1f7; /* Water blue color */
        }
        .correct-answer-icon {
            background-color: #4f008c;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .user-guess-icon {
            background-color: #f5a623;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        /* Ensure overlays cover the screen */
        .screen-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 2rem;
            z-index: 30;
        }
        .mastery-star {
            color: #FFD700; /* Gold color for stars */
            text-shadow: 0 0 2px black;
        }
        .mastery-star-empty {
            color: #a0a0a0;
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <!-- Main Game Container -->
    <div id="game-container" class="relative w-screen h-screen">
        
        <div id="map"></div>

        <!-- Quiz Start Screen Overlay -->
        <div id="quiz-start-screen" class="screen-overlay">
            <h1 id="quiz-title" class="text-4xl md:text-6xl font-extrabold mb-4 text-purple-300">Thai Airways Route Challenge</h1>
            <p id="quiz-description" class="text-lg md:text-xl mb-8 max-w-2xl">Find the destination on the world map.</p>
            <div id="progress-summary" class="mb-8 text-lg bg-black/30 p-4 rounded-lg">
                <p>Mastered: <span id="mastered-count">0</span> / 63</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="start-quiz-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    Start Quiz
                </button>
            </div>
        </div>

        <!-- Game UI Overlay -->
        <div id="game-ui" class="absolute top-0 left-0 w-full p-4 md:p-6 z-20 hidden pointer-events-none">
            <div class="max-w-7xl mx-auto flex justify-between items-center bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg pointer-events-auto">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-500">Find this destination:</p>
                    <div class="flex items-center gap-2">
                        <h2 id="destination-prompt" class="text-xl md:text-3xl font-bold text-purple-800"></h2>
                        <span id="mastery-display" class="text-xl md:text-2xl"></span>
                    </div>
                </div>
                <div class="text-right ml-4">
                     <p class="text-sm font-medium text-gray-500">Question</p>
                    <p id="question-counter" class="text-xl md:text-3xl font-bold text-gray-700"></p>
                </div>
                 <div class="text-right ml-4 border-l pl-4">
                     <p class="text-sm font-medium text-gray-500">Score</p>
                    <p id="score-counter" class="text-2xl md:text-3xl font-bold text-green-600">0</p>
                </div>
            </div>
        </div>
        
        <div id="feedback-box" class="absolute bottom-0 left-0 w-full p-4 md:p-6 z-20 hidden pointer-events-none">
            <div class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-2xl text-center pointer-events-auto">
                <p id="feedback-text" class="text-xl font-semibold mb-4"></p>
                <p id="feedback-details" class="text-gray-600 mb-4"></p>
                <button id="next-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105">
                    Next Question
                </button>
            </div>
        </div>

         <div id="end-screen" class="screen-overlay hidden">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 text-purple-300">Quiz Complete!</h1>
            <p class="text-lg md:text-xl mb-4">Your Final Score:</p>
            <p id="final-score" class="text-7xl font-bold mb-8 text-green-400"></p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="restart-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    Play Again
                </button>
                <button id="reset-progress-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    Reset Progress
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DATASETS ---
        const airwaysDestinations = [
            { city: "Chiang Mai", country: "Thailand", lat: 18.7669, lon: 98.9626 }, { city: "Chiang Rai", country: "Thailand", lat: 19.9546, lon: 99.8828 }, { city: "Khon Kaen", country: "Thailand", lat: 16.4673, lon: 102.7852 }, { city: "Udon Thani", country: "Thailand", lat: 17.3871, lon: 102.8122 }, { city: "Ubon Ratchathani", country: "Thailand", lat: 15.2508, lon: 104.8690 }, { city: "Krabi", country: "Thailand", lat: 8.0945, lon: 98.9877 }, { city: "Hat Yai", country: "Thailand", lat: 6.9328, lon: 100.3950 }, { city: "Phuket", country: "Thailand", lat: 8.1132, lon: 98.3168 }, { city: "Ahmedabad", country: "India", lat: 23.0734, lon: 72.6347 }, { city: "Beijing", country: "China", lat: 40.0801, lon: 116.5845 }, { city: "Bengaluru", country: "India", lat: 13.1986, lon: 77.7063 }, { city: "Chennai", country: "India", lat: 12.9941, lon: 80.1709 }, { city: "Chengdu", country: "China", lat: 30.5785, lon: 103.9485 }, { city: "Colombo", country: "Sri Lanka", lat: 7.1802, lon: 79.8842 }, { city: "Dhaka", country: "Bangladesh", lat: 23.8433, lon: 90.3978 }, { city: "Delhi", country: "India", lat: 28.5562, lon: 77.1000 }, { city: "Denpasar", country: "Indonesia", lat: -8.7482, lon: 115.1672 }, { city: "Fukuoka", country: "Japan", lat: 33.5858, lon: 130.4505 }, { city: "Guangzhou", country: "China", lat: 23.3924, lon: 113.2988 }, { city: "Hanoi", country: "Vietnam", lat: 21.2212, lon: 105.8072 }, { city: "Ho Chi Minh City", country: "Vietnam", lat: 10.8222, lon: 106.6619 }, { city: "Hong Kong", country: "Hong Kong", lat: 22.3080, lon: 113.9185 }, { city: "Hyderabad", country: "India", lat: 17.2403, lon: 78.4294 }, { city: "Islamabad", country: "Pakistan", lat: 33.5492, lon: 72.8256 }, { city: "Jakarta", country: "Indonesia", lat: -6.1256, lon: 106.6558 }, { city: "Karachi", country: "Pakistan", lat: 24.9073, lon: 67.1608 }, { city: "Kathmandu", country: "Nepal", lat: 27.6966, lon: 85.3591 }, { city: "Kaohsiung", country: "Taiwan", lat: 22.5768, lon: 120.3499 }, { city: "Kochi", country: "India", lat: 10.1520, lon: 76.4019 }, { city: "Kolkata", country: "India", lat: 22.6547, lon: 88.4467 }, { city: "Kuala Lumpur", country: "Malaysia", lat: 2.7456, lon: 101.7099 }, { city: "Kunming", country: "China", lat: 25.1019, lon: 102.928 }, { city: "Lahore", country: "Pakistan", lat: 31.5216, lon: 74.4036 }, { city: "Manila", country: "Philippines", lat: 14.5086, lon: 121.0194 }, { city: "Mumbai", country: "India", lat: 19.0896, lon: 72.8656 }, { city: "Nagoya", country: "Japan", lat: 34.8584, lon: 136.8054 }, { city: "Osaka", country: "Japan", lat: 34.4272, lon: 135.2442 }, { city: "Penang", country: "Malaysia", lat: 5.2971, lon: 100.2766 }, { city: "Phnom Penh", country: "Cambodia", lat: 11.5466, lon: 104.8441 }, { city: "Sapporo", country: "Japan", lat: 42.7752, lon: 141.6923 }, { city: "Seoul", country: "South Korea", lat: 37.4602, lon: 126.4407 }, { city: "Shanghai", country: "China", lat: 31.1444, lon: 121.8053 }, { city: "Siem Reap", country: "Cambodia", lat: 13.4107, lon: 103.8121 }, { city: "Singapore", country: "Singapore", lat: 1.3644, lon: 103.9915 }, { city: "Taipei", country: "Taiwan", lat: 25.0797, lon: 121.2345 }, { city: "Tokyo (Haneda)", country: "Japan", lat: 35.5494, lon: 139.7798 }, { city: "Tokyo (Narita)", country: "Japan", lat: 35.7720, lon: 140.3863 }, { city: "Vientiane", country: "Laos", lat: 17.9883, lon: 102.5633 }, { city: "Yangon", country: "Myanmar", lat: 16.9073, lon: 96.1332 }, { city: "Brussels", country: "Belgium", lat: 50.9014, lon: 4.4844 }, { city: "Copenhagen", country: "Denmark", lat: 55.6180, lon: 12.6560 }, { city: "Frankfurt", country: "Germany", lat: 50.0379, lon: 8.5622 }, { city: "Istanbul", country: "Turkey", lat: 41.2753, lon: 28.7519 }, { city: "London", country: "United Kingdom", lat: 51.4700, lon: -0.4543 }, { city: "Melbourne", country: "Australia", lat: -37.6690, lon: 144.8410 }, { city: "Milan", country: "Italy", lat: 45.6301, lon: 8.7285 }, { city: "Munich", country: "Germany", lat: 48.3537, lon: 11.7861 }, { city: "Oslo", country: "Norway", lat: 60.1976, lon: 11.1004 }, { city: "Paris", country: "France", lat: 49.0097, lon: 2.5479 }, { city: "Perth", country: "Australia", lat: -31.9403, lon: 115.9672 }, { city: "Stockholm", country: "Sweden", lat: 59.6498, lon: 17.9238 }, { city: "Sydney", country: "Australia", lat: -33.9399, lon: 151.1753 }, { city: "Zurich", country: "Switzerland", lat: 47.4647, lon: 8.5492 }
        ];

        // --- DOM Elements ---
        const quizStartScreen = document.getElementById('quiz-start-screen');
        const endScreen = document.getElementById('end-screen');
        const gameUI = document.getElementById('game-ui');
        const startQuizButton = document.getElementById('start-quiz-button');
        const restartButton = document.getElementById('restart-button');
        const resetProgressButton = document.getElementById('reset-progress-button');
        const destinationPrompt = document.getElementById('destination-prompt');
        const questionCounter = document.getElementById('question-counter');
        const scoreCounter = document.getElementById('score-counter');
        const finalScore = document.getElementById('final-score');
        const feedbackBox = document.getElementById('feedback-box');
        const feedbackText = document.getElementById('feedback-text');
        const feedbackDetails = document.getElementById('feedback-details');
        const nextButton = document.getElementById('next-button');
        const masteryDisplay = document.getElementById('mastery-display');
        const masteredCount = document.getElementById('mastered-count');
        
        // --- Game State ---
        let map;
        let score = 0;
        let currentQuestionIndex = 0;
        let shuffledDestinations = [];
        let mapClickListener;
        let guessMarker = null;
        let answerMarker = null;
        let lineToAnswer = null;
        let destinationProgress = {};

        // --- Progress Tracking ---
        function loadProgress() {
            const savedProgress = localStorage.getItem('thaiAirwaysProgress');
            if (savedProgress) {
                destinationProgress = JSON.parse(savedProgress);
            } else {
                // Initialize progress for all destinations if none is saved
                airwaysDestinations.forEach(dest => {
                    destinationProgress[dest.city] = 0;
                });
            }
            updateProgressSummary();
        }

        function saveProgress() {
            localStorage.setItem('thaiAirwaysProgress', JSON.stringify(destinationProgress));
            updateProgressSummary();
        }

        function resetProgress() {
            if (confirm("Are you sure you want to reset all your progress? This cannot be undone.")) {
                airwaysDestinations.forEach(dest => {
                    destinationProgress[dest.city] = 0;
                });
                saveProgress();
                endScreen.classList.add('hidden');
                quizStartScreen.classList.remove('hidden');
            }
        }

        function updateProgressSummary() {
            const mastered = Object.values(destinationProgress).filter(level => level >= 3).length;
            masteredCount.textContent = mastered;
        }

        function getMasteryStars(city) {
            const level = destinationProgress[city] || 0;
            if (level >= 3) return '<span class="mastery-star">★★★</span>'; // Mastered
            if (level === 2) return '<span class="mastery-star">★★</span><span class="mastery-star-empty">☆</span>'; // Familiar
            if (level === 1) return '<span class="mastery-star">★</span><span class="mastery-star-empty">☆☆</span>'; // Learning
            return '<span class="mastery-star-empty">☆☆☆</span>'; // Unseen
        }


        // --- Map Initialization ---
        function initMap() {
            if (map) return;
            map = L.map('map', { center: [20, 100], zoom: 3, minZoom: 2, maxBounds: [[-90, -180], [90, 180]], worldCopyJump: true });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            }).addTo(map);
        }

        function startGame() {
            quizStartScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameUI.classList.remove('hidden');
            score = 0;
            currentQuestionIndex = 0;
            updateScoreDisplay();
            shuffledDestinations = [...airwaysDestinations].sort(() => Math.random() - 0.5);
            nextQuestion();
        }
        
        // --- Click Logic ---
        function handleMapClick(e) {
            map.off('click', mapClickListener);

            const userLatLng = e.latlng;
            const correctDestination = shuffledDestinations[currentQuestionIndex];
            const correctLatLng = L.latLng(correctDestination.lat, correctDestination.lon);
            const distance = calculateDistance(userLatLng.lat, userLatLng.lng, correctLatLng.lat, correctLatLng.lng);
            
            guessMarker = L.marker(userLatLng, { icon: L.divIcon({ className: 'user-guess-icon', iconSize: [12, 12] }) }).addTo(map);
            answerMarker = L.marker(correctLatLng, { icon: L.divIcon({ className: 'correct-answer-icon', iconSize: [12, 12] }) }).addTo(map).bindPopup(`<b>${correctDestination.city}</b>`).openPopup();
            lineToAnswer = L.polyline([userLatLng, correctLatLng], { color: '#4f008c', weight: 2, dashArray: '5, 5' }).addTo(map);
            map.fitBounds(L.latLngBounds(userLatLng, correctLatLng), { padding: [70, 70] });
            
            const isCorrect = distance <= 150;
            showFeedback(isCorrect, `You were ${Math.round(distance)} km away.`);
        }
        
        // --- Game Flow Logic ---
        function nextQuestion() {
            clearMapLayers();
            feedbackBox.classList.add('hidden');

            if (currentQuestionIndex >= shuffledDestinations.length) {
                endGame();
                return;
            }
            updateQuestionDisplay();
            mapClickListener = map.on('click', handleMapClick);
        }

        function showFeedback(isCorrect, detailsText) {
            const correctDestination = shuffledDestinations[currentQuestionIndex];
            if (isCorrect) {
                score++;
                updateScoreDisplay();
                feedbackText.textContent = "Excellent! You are correct!";
                feedbackText.classList.remove('text-red-600');
                feedbackText.classList.add('text-green-600');
                // Increment progress
                destinationProgress[correctDestination.city] = (destinationProgress[correctDestination.city] || 0) + 1;
                saveProgress();
            } else {
                feedbackText.textContent = `Not quite! The correct answer was ${correctDestination.city}.`;
                feedbackText.classList.remove('text-green-600');
                feedbackText.classList.add('text-red-600');
            }
            feedbackDetails.textContent = detailsText;
            feedbackBox.classList.remove('hidden');
            currentQuestionIndex++;
        }
        
        function endGame() {
            gameUI.classList.add('hidden');
            feedbackBox.classList.add('hidden');
            finalScore.textContent = `${score} / ${shuffledDestinations.length}`;
            endScreen.classList.remove('hidden');
        }

        function clearMapLayers() {
            if (guessMarker) map.removeLayer(guessMarker);
            if (answerMarker) map.removeLayer(answerMarker);
            if (lineToAnswer) map.removeLayer(lineToAnswer);
            if(map) map.closePopup();
            guessMarker = null;
            answerMarker = null;
            lineToAnswer = null;
        }

        function updateScoreDisplay() {
            scoreCounter.textContent = score;
        }

        function updateQuestionDisplay() {
             const currentDestination = shuffledDestinations[currentQuestionIndex];
             const promptText = `${currentDestination.city}, ${currentDestination.country}`;
             destinationPrompt.textContent = promptText;
             questionCounter.textContent = `${currentQuestionIndex + 1} / ${shuffledDestinations.length}`;
             masteryDisplay.innerHTML = getMasteryStars(currentDestination.city);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // --- Event Listeners ---
        startQuizButton.addEventListener('click', startGame);
        nextButton.addEventListener('click', nextQuestion);
        restartButton.addEventListener('click', startGame);
        resetProgressButton.addEventListener('click', resetProgress);
       
        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadProgress();
        });

    </script>
</body>
</html>

